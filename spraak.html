<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combot - Spraakmodus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
            z-index: 10;
            position: relative;
        }

        .microphone {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #4a6cf7, #7a52d4);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(74, 108, 247, 0.4);
            border: none;
            outline: none;
            position: relative;
        }

        .microphone:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(74, 108, 247, 0.6);
        }

        .microphone:active {
            transform: scale(0.95);
        }

        .microphone.off {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            box-shadow: 0 15px 35px rgba(108, 117, 125, 0.4);
        }

        .microphone.listening {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            animation: pulse 1.5s infinite;
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.6);
        }

        .microphone.processing {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            animation: processing 2s infinite;
            box-shadow: 0 15px 35px rgba(255, 167, 38, 0.6);
        }

        .noise-filter {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .noise-filter.active {
            background: rgba(76, 175, 80, 0.8);
            animation: filterPulse 2s infinite;
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); 
            }
            50% { 
                transform: scale(1.05);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 20px rgba(255, 107, 107, 0); 
            }
        }

        @keyframes processing {
            0% { 
                background: linear-gradient(135deg, #ffa726, #ff9800);
            }
            50% { 
                background: linear-gradient(135deg, #ffb74d, #ffa726);
            }
            100% { 
                background: linear-gradient(135deg, #ffa726, #ff9800);
            }
        }

        @keyframes filterPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .volume-indicator {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .volume-level {
            height: 100%;
            background: white;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .noise-threshold {
            position: absolute;
            top: 0;
            left: 30%;
            width: 2px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
        }

        /* Woord animatie styles */
        .word-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .learned-word {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            animation: floatAcross 15s linear infinite;
            opacity: 0;
        }

        @keyframes floatAcross {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px));
                opacity: 0;
            }
        }

        .word-bubble {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sensitivity-control {
            width: 100%;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sensitivity-label {
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sensitivity-slider {
            width: 120px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .sensitivity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="word-animation" id="wordAnimation"></div>
    
    <div class="container">
        <button class="microphone" id="microphone">
            üé§
            <div class="noise-filter" id="noiseFilter">üîá</div>
        </button>
        
        <div class="volume-indicator">
            <div class="noise-threshold"></div>
            <div class="volume-level" id="volume-level"></div>
        </div>

        <div class="sensitivity-control">
            <span class="sensitivity-label">üí¨</span>
            <input type="range" min="1" max="10" value="6" class="sensitivity-slider" id="sensitivitySlider">
            <span class="sensitivity-label">üîä</span>
        </div>
        
        <button class="back-btn" onclick="window.location.href='index.html'">
            ‚Üê
        </button>
    </div>

    <script>
        // Elementen
        const microphone = document.getElementById('microphone');
        const volumeLevel = document.getElementById('volume-level');
        const noiseFilter = document.getElementById('noiseFilter');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const wordAnimation = document.getElementById('wordAnimation');
        
        // Variabelen voor ruisonderdrukking
        let isListening = false;
        let isProcessing = false;
        let isSpeaking = false;
        let recognition = null;
        let audioContext = null;
        let analyser = null;
        let microphoneSource = null;
        let javascriptNode = null;
        let sensitivity = 6;
        let silenceCounter = 0;
        let speechBuffer = [];
        let lastSpeechTime = 0;
        
        // Geleerde woorden opslag
        let learnedWords = [];
        let recentlyLearnedWords = [];
        let wordAnimationInterval = null;

        // Woord animatie initialiseren
        function initializeWordAnimation() {
            loadLearnedWords();
            wordAnimationInterval = setInterval(createFloatingWord, 3000);
        }

        // Laad geleerde woorden
        function loadLearnedWords() {
            try {
                // Laad woorden uit verschillende bronnen
                const storedPatterns = localStorage.getItem('combotLearnedPatterns');
                const storedPersonality = localStorage.getItem('combotPersonality');
                const storedWebsiteWords = localStorage.getItem('combotWebsiteWords');
                
                learnedWords = [];
                
                // Woorden uit patronen
                if (storedPatterns) {
                    const patterns = JSON.parse(storedPatterns);
                    for (const category in patterns) {
                        patterns[category].forEach(word => {
                            if (!learnedWords.includes(word)) {
                                learnedWords.push(word);
                            }
                        });
                    }
                }
                
                // Persoonlijke woorden
                if (storedPersonality) {
                    const personality = JSON.parse(storedPersonality);
                    personality.learnedWords.forEach(word => {
                        if (!learnedWords.includes(word)) {
                            learnedWords.push(word);
                        }
                    });
                }
                
                // Website woorden
                if (storedWebsiteWords) {
                    const websiteWords = JSON.parse(storedWebsiteWords);
                    websiteWords.forEach(word => {
                        if (!learnedWords.includes(word)) {
                            learnedWords.push(word);
                        }
                    });
                }
                
                // Voeg standaard woorden toe als er geen zijn
                if (learnedWords.length === 0) {
                    learnedWords = [
                        "hallo", "ai", "slim", "leren", "praten", "vragen",
                        "antwoord", "grappig", "leuk", "interessant", "help",
                        "uitleg", "bedankt", "combinatie", "technologie"
                    ];
                }
            } catch (error) {
                console.error('Fout bij laden woorden:', error);
                learnedWords = ["hallo", "ai", "slim", "leren"];
            }
        }

        // Cre√´er zwevend woord
        function createFloatingWord() {
            if (learnedWords.length === 0) return;
            
            // Gebruik recent geleerde woorden eerst, anders willekeurig woord
            let randomWord;
            if (recentlyLearnedWords.length > 0) {
                randomWord = recentlyLearnedWords.shift();
            } else {
                randomWord = learnedWords[Math.floor(Math.random() * learnedWords.length)];
            }
            
            const wordElement = document.createElement('div');
            wordElement.className = 'learned-word';
            
            // Willekeurige verticale positie
            const topPosition = 10 + Math.random() * 80;
            wordElement.style.top = topPosition + '%';
            
            // Willekeurige vertraging voor animatie
            const animationDelay = Math.random() * 3;
            wordElement.style.animationDelay = animationDelay + 's';
            
            // Willekeurige animatie duur
            const animationDuration = 12 + Math.random() * 8;
            wordElement.style.animationDuration = animationDuration + 's';
            
            // Woord in bubbel
            wordElement.innerHTML = `<div class="word-bubble">${randomWord}</div>`;
            
            wordAnimation.appendChild(wordElement);
            
            // Verwijder element na animatie
            setTimeout(() => {
                if (wordElement.parentNode) {
                    wordElement.parentNode.removeChild(wordElement);
                }
            }, (animationDuration + animationDelay) * 1000);
        }

        // Voeg nieuw woord toe aan recent geleerde woorden
        function addRecentlyLearnedWord(word) {
            const cleanWord = word.toLowerCase().trim();
            
            // Filter korte woorden en veelvoorkomende woorden
            const commonWords = ["de", "het", "een", "en", "of", "maar", "dan", "om", "naar"];
            if (cleanWord.length < 3 || commonWords.includes(cleanWord)) {
                return;
            }
            
            // Voeg toe aan recente woorden voor animatie
            if (!recentlyLearnedWords.includes(cleanWord) && !learnedWords.includes(cleanWord)) {
                recentlyLearnedWords.push(cleanWord);
                learnedWords.push(cleanWord);
                
                // Toon direct het nieuwe woord
                createFloatingWord();
            }
        }

        // Spraakherkenning initialiseren
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'nl-NL';
                
                recognition.onstart = function() {
                    isListening = true;
                    updateMicrophoneUI();
                    noiseFilter.classList.add('active');
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let hasValidSpeech = false;
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        const confidence = result[0].confidence;
                        
                        if (result.isFinal && confidence > 0.6) {
                            finalTranscript += transcript;
                            hasValidSpeech = true;
                            
                            // Voeg woorden toe aan recent geleerde woorden
                            const words = transcript.split(/\s+/);
                            words.forEach(word => addRecentlyLearnedWord(word));
                        }
                    }
                    
                    if (hasValidSpeech) {
                        lastSpeechTime = Date.now();
                        silenceCounter = 0;
                    }
                    
                    if (finalTranscript.trim() && !isProcessing && !isSpeaking && hasValidSpeech) {
                        processSpeechInput(finalTranscript);
                    }
                };
                
                recognition.onerror = function(event) {
                    if (event.error === 'not-allowed') {
                        toggleMicrophone();
                    } else if (event.error !== 'no-speech') {
                        setTimeout(() => {
                            if (isListening && recognition) {
                                recognition.start();
                            }
                        }, 1000);
                    }
                };
                
                recognition.onend = function() {
                    isListening = false;
                    noiseFilter.classList.remove('active');
                    
                    if (!microphone.classList.contains('off')) {
                        setTimeout(() => {
                            if (!isProcessing && !isSpeaking && recognition) {
                                recognition.start();
                            }
                        }, 500);
                    }
                };
                
                recognition.start();
                
            } else {
                microphone.classList.add('off');
                microphone.innerHTML = '‚ùå';
            }
        }
        
        // Audio analyse initialiseren
        function initializeAudioAnalysis() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000,
                        channelCount: 1
                    },
                    video: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        
                        const source = audioContext.createMediaStreamSource(stream);
                        
                        const lowPassFilter = audioContext.createBiquadFilter();
                        lowPassFilter.type = "lowpass";
                        lowPassFilter.frequency.value = 4000;
                        
                        const highPassFilter = audioContext.createBiquadFilter();
                        highPassFilter.type = "highpass";
                        highPassFilter.frequency.value = 80;
                        
                        source.connect(highPassFilter);
                        highPassFilter.connect(lowPassFilter);
                        lowPassFilter.connect(analyser);
                        
                        analyser.fftSize = 2048;
                        analyser.smoothingTimeConstant = 0.8;
                        
                        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                        analyser.connect(javascriptNode);
                        javascriptNode.connect(audioContext.destination);
                        
                        let noiseBaseline = 0;
                        let calibrationSamples = 0;
                        const maxCalibrationSamples = 100;
                        
                        javascriptNode.onaudioprocess = function() {
                            const array = new Uint8Array(analyser.frequencyBinCount);
                            analyser.getByteFrequencyData(array);
                            
                            let sum = 0;
                            for (let i = 0; i < array.length; i++) {
                                sum += array[i] * array[i];
                            }
                            const rms = Math.sqrt(sum / array.length) / 255;
                            
                            if (calibrationSamples < maxCalibrationSamples) {
                                noiseBaseline = (noiseBaseline * calibrationSamples + rms) / (calibrationSamples + 1);
                                calibrationSamples++;
                            }
                            
                            const adjustedSensitivity = sensitivity / 10;
                            const dynamicThreshold = noiseBaseline + (0.3 * adjustedSensitivity);
                            
                            let filteredVolume = 0;
                            if (rms > dynamicThreshold) {
                                filteredVolume = (rms - dynamicThreshold) / (1 - dynamicThreshold);
                                filteredVolume = Math.min(filteredVolume * (1 + adjustedSensitivity), 1);
                            }
                            
                            const displayVolume = Math.min(filteredVolume * 100, 100);
                            volumeLevel.style.width = displayVolume + '%';
                            
                            const currentTime = Date.now();
                            if (filteredVolume > 0.1) {
                                lastSpeechTime = currentTime;
                                silenceCounter = 0;
                            } else if (currentTime - lastSpeechTime > 1500 && speechBuffer.length > 0) {
                                silenceCounter++;
                                if (silenceCounter > 3) {
                                    const finalText = speechBuffer.join(' ');
                                    if (finalText.trim().length > 2) {
                                        processSpeechInput(finalText);
                                    }
                                    speechBuffer = [];
                                    silenceCounter = 0;
                                }
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error('Microfoon toegang fout:', err);
                        noiseFilter.textContent = '‚ùå';
                    });
            }
        }
        
        // Microfoon UI updaten
        function updateMicrophoneUI() {
            microphone.classList.remove('off', 'listening', 'processing');
            
            if (isSpeaking) {
                microphone.classList.add('listening');
                microphone.innerHTML = 'üîä';
            } else if (isProcessing) {
                microphone.classList.add('processing');
                microphone.innerHTML = '‚è≥';
            } else if (isListening) {
                microphone.classList.add('listening');
                microphone.innerHTML = 'üé§';
            } else {
                microphone.classList.add('off');
                microphone.innerHTML = 'üé§';
            }
            
            microphone.innerHTML += '<div class="noise-filter" id="noiseFilter">üîá</div>';
            if (isListening) {
                noiseFilter.classList.add('active');
            }
        }
        
        // Spraak functie
        function speakText(text) {
            return new Promise((resolve) => {
                if ('speechSynthesis' in window) {
                    isSpeaking = true;
                    updateMicrophoneUI();
                    
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'nl-NL';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    utterance.onend = function() {
                        isSpeaking = false;
                        updateMicrophoneUI();
                        resolve();
                    };
                    
                    utterance.onerror = function() {
                        isSpeaking = false;
                        updateMicrophoneUI();
                        resolve();
                    };
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    resolve();
                }
            });
        }
        
        // Verwerk gesproken invoer
        async function processSpeechInput(transcript) {
            if (!transcript.trim() || isProcessing || isSpeaking) return;
            
            const cleanTranscript = transcript.trim();
            if (cleanTranscript.length < 2) return;
            
            const noisePatterns = [/^eh+$/, /^uh+$/, /^ah+$/, /^oh+$/, /^\s+$/];
            if (noisePatterns.some(pattern => pattern.test(cleanTranscript.toLowerCase()))) {
                return;
            }
            
            isProcessing = true;
            updateMicrophoneUI();
            
            const response = await generateAIResponse(cleanTranscript);
            
            await speakText(response);
            
            isProcessing = false;
            updateMicrophoneUI();
            
            if (!isListening && recognition && !microphone.classList.contains('off')) {
                setTimeout(() => {
                    recognition.start();
                }, 500);
            }
        }
        
        // Genereer AI antwoord
        async function generateAIResponse(input) {
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 800));
            
            const lowerInput = input.toLowerCase();
            
            if (lowerInput.includes('hallo') || lowerInput.includes('hoi') || lowerInput.includes('hey')) {
                return "Hallo! Ik hoor je goed. Hoe kan ik helpen?";
            } else if (lowerInput.includes('hoe gaat het')) {
                return "Prima, dank je! De ruisonderdrukking werkt goed. En met jou?";
            } else if (lowerInput.includes('wat kan je')) {
                return "Ik luister naar je stem en filter achtergrondgeluid. Praat gewoon tegen me!";
            } else if (lowerInput.includes('dankjewel') || lowerInput.includes('bedankt')) {
                return "Graag gedaan! De microfoon staat klaar voor je volgende vraag.";
            } else if (lowerInput.includes('stop') || lowerInput.includes('einde')) {
                return "Tot ziens! Klik op de microfoon als je weer wilt praten.";
            } else if (lowerInput.includes('ruis') || lowerInput.includes('filter')) {
                return "De ruisonderdrukking is actief. Ik filter achtergrondgeluid voor betere herkenning.";
            } else if (lowerInput.includes('microfoon')) {
                return "De microfoon staat aan met geavanceerde ruisonderdrukking. Praat duidelijk voor beste resultaten.";
            } else if (lowerInput.includes('woorden') || lowerInput.includes('leren')) {
                return "Ik leer continu nieuwe woorden van onze gesprekken. Kijk hoe ze over het scherm bewegen!";
            } else {
                const randomResponses = [
                    "Ik begrijp het. Kun je iets meer uitleg geven?",
                    "Interessant! Wat bedoel je precies?",
                    "Goed punt. Wil je hier meer over weten?",
                    "Ik verwerk je vraag. Kun je het anders formuleren?",
                    "Duidelijk. Is er iets specifieks dat je wilt vragen?"
                ];
                return randomResponses[Math.floor(Math.random() * randomResponses.length)];
            }
        }
        
        // Microfoon aan/uit zetten
        function toggleMicrophone() {
            if (microphone.classList.contains('off')) {
                microphone.classList.remove('off');
                initializeSpeechRecognition();
                initializeAudioAnalysis();
            } else {
                microphone.classList.add('off');
                isListening = false;
                isProcessing = false;
                
                if (recognition) {
                    recognition.stop();
                }
                
                if (audioContext) {
                    audioContext.close();
                }
                
                window.speechSynthesis.cancel();
                volumeLevel.style.width = '0%';
                noiseFilter.classList.remove('active');
            }
        }
        
        // Gevoeligheid aanpassen
        sensitivitySlider.addEventListener('input', function() {
            sensitivity = parseInt(this.value);
            document.querySelector('.noise-threshold').style.left = (30 + (sensitivity * 4)) + '%';
        });
        
        // Microfoon klik event
        microphone.addEventListener('click', toggleMicrophone);
        
        // Initialiseer bij laden
        window.onload = function() {
            initializeWordAnimation();
            initializeSpeechRecognition();
            initializeAudioAnalysis();
            
            // Welkomstbericht
            setTimeout(() => {
                if (!isProcessing && !isSpeaking) {
                    speakText("Welkom bij Combot spraakmodus. Ik luister constant naar je. Praat gewoon tegen me!");
                }
            }, 1000);
        };
        
        // Opruimen bij verlaten pagina
        window.onbeforeunload = function() {
            if (recognition) {
                recognition.stop();
            }
            if (audioContext) {
                audioContext.close();
            }
            if (wordAnimationInterval) {
                clearInterval(wordAnimationInterval);
            }
            window.speechSynthesis.cancel();
        };
    </script>
</body>
</html>
