<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combot</title>
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #7a52d4;
            --danger-color: #ff6b6b;
            --success-color: #28a745;
            --text-color: #333;
            --bg-color: #fff;
            --message-bg: #f0f0f0;
            --user-message-bg: #4a6cf7;
            --user-message-color: #fff;
            --border-color: #e0e0e0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #6e8efb;
                --secondary-color: #a777e3;
                --danger-color: #ff5252;
                --success-color: #34c759;
                --text-color: #f0f0f0;
                --bg-color: #1a1a1a;
                --message-bg: #2d2d2d;
                --user-message-bg: #4a6cf7;
                --user-message-color: #fff;
                --border-color: #404040;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            color: var(--text-color);
        }

        .container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            background-color: var(--bg-color);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            margin-left: 50px;
        }

        .hamburger-menu {
            position: absolute;
            left: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .hamburger-menu:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-color);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease;
            z-index: 999;
            padding: 80px 20px 20px 20px;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar.closing {
            left: -300px;
            transition: left 0.3s ease;
        }

        .sidebar h3 {
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .menu-btn {
            width: 100%;
            padding: 12px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .menu-btn:hover {
            background: var(--secondary-color);
            transform: translateX(5px);
        }

        .menu-btn.active {
            background: var(--danger-color);
        }

        .speech-mode-btn {
            background: linear-gradient(135deg, var(--danger-color), #ff5252);
            width: 100%;
            padding: 12px 15px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .speech-mode-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff3838);
            transform: translateX(5px);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-color);
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            animation: messageSlide 0.3s ease;
            position: relative;
        }

        @keyframes messageSlide {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--user-message-bg), var(--secondary-color));
            color: var(--user-message-color);
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--message-bg);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 5px;
        }

        .bot-message img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .analysis-message {
            align-self: flex-start;
            background-color: #fff8e1;
            border: 1px solid #ffeaa7;
            border-bottom-left-radius: 5px;
            font-size: 0.85rem;
            color: #856404;
        }

        @media (prefers-color-scheme: dark) {
            .analysis-message {
                background-color: #333300;
                border-color: #666633;
                color: #ffcc00;
            }
        }

        .thinking {
            align-self: flex-start;
            background-color: var(--message-bg);
            padding: 10px 15px;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            font-style: italic;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: thinkingPulse 1.5s infinite;
        }

        @keyframes thinkingPulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .thinking-dots {
            display: flex;
            gap: 3px;
        }

        .thinking-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-color);
            animation: dotPulse 1.5s infinite;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .input-container {
            display: flex;
            padding: 15px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            gap: 10px;
            flex-shrink: 0;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }

        #send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        #send-btn:hover {
            transform: scale(1.1);
        }

        #send-btn:active {
            transform: scale(0.95);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 998;
            cursor: pointer;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .overlay.closing {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        /* Geheugen beheer stijlen */
        .memory-management {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            overflow: hidden;
            flex-direction: column;
        }

        .memory-management.active {
            display: flex;
        }

        .memory-header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-header h2 {
            font-size: 1.3rem;
        }

        .close-memory {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .close-memory:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .memory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .search-container {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }

        .memory-section {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background: var(--message-bg);
        }

        .memory-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-count {
            background: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .words-list, .phrases-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .word-item, .phrase-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: var(--message-bg);
            border-radius: 15px;
            font-size: 0.8rem;
            color: var(--primary-color);
            animation: memoryItemPop 0.3s ease;
        }

        .word-item:hover, .phrase-item:hover {
            background: var(--primary-color);
            color: white;
        }

        .delete-word, .delete-phrase {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            cursor: pointer;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .delete-word:hover, .delete-phrase:hover {
            background: #ff5252;
            transform: scale(1.2);
        }

        .memory-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }

        .memory-action-btn {
            flex: 1;
            padding: 12px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .memory-action-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .memory-action-btn.clear-all {
            background: var(--danger-color);
        }

        .memory-action-btn.clear-all:hover {
            background: #ff5252;
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 280px;
            }
            
            .header h1 {
                font-size: 1.3rem;
                margin-left: 40px;
            }
            
            .message {
                max-width: 90%;
            }

            .memory-management {
                width: 95%;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 15px;
                min-height: 60px;
            }
            
            .header h1 {
                font-size: 1.2rem;
                margin-left: 35px;
            }
            
            .hamburger-menu {
                left: 15px;
                font-size: 1.3rem;
            }
            
            .sidebar {
                width: 100%;
                left: -100%;
            }
            
            .chat-container {
                padding: 15px;
            }
            
            .input-container {
                padding: 12px;
            }

            .memory-content {
                padding: 15px;
            }

            .memory-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="hamburger-menu">☰</button>
            <h1>Combot</h1>
        </div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3>Modus</h3>
                <button class="menu-btn" id="analysis-btn">Analyse Aan</button>
                <button class="menu-btn" id="memory-management-btn">Geheugen beheren</button>
                <button class="speech-mode-btn" id="speech-mode-btn">Spraakmodus</button>
            </div>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div class="chat-container" id="chat-container">
            <!-- Hier komen de berichten -->
        </div>
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Typ je bericht hier... of 'leer vraag = antwoord'">
            <button id="send-btn">➤</button>
        </div>
    </div>

    <!-- Geheugen beheer modal -->
    <div class="memory-management" id="memory-management">
        <div class="memory-header">
            <h2>Geheugen Beheren</h2>
            <button class="close-memory" id="close-memory">×</button>
        </div>
        <div class="memory-content">
            <div class="search-container">
                <input type="text" class="search-input" id="memory-search" placeholder="Zoek in geheugen...">
            </div>
            
            <div class="memory-section">
                <h3>Geleerde woorden <span class="section-count" id="words-count">0</span></h3>
                <div class="words-list" id="words-list">
                    <!-- Geleerde woorden komen hier -->
                </div>
            </div>
            
            <div class="memory-section">
                <h3>Geleerde zinnen per categorie <span class="section-count" id="phrases-count">0</span></h3>
                <div class="phrases-list" id="phrases-list">
                    <!-- Geleerde zinnen komen hier -->
                </div>
            </div>
            
            <div class="memory-actions">
                <button class="memory-action-btn" id="export-memory">Exporteren</button>
                <button class="memory-action-btn clear-all" id="clear-all-memory">Alles Wissen</button>
            </div>
        </div>
    </div>

    <script>
        // GLOBALE VARIABELEN
        let githubQA = [];
        let imagesQA = [];
        let learnedQA = [];
        let knowledgeBase = {};
        let learnedPatterns = {};
        let botPersonality = {};
        let analysisMode = false;
        let totalMessages = 0;
        let totalLearned = 0;

        // ELEMENTEN
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const hamburgerMenu = document.querySelector('.hamburger-menu');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const analysisBtn = document.getElementById('analysis-btn');
        const memoryManagementBtn = document.getElementById('memory-management-btn');
        const speechModeBtn = document.getElementById('speech-mode-btn');
        const memoryManagement = document.getElementById('memory-management');
        const closeMemory = document.getElementById('close-memory');
        const memorySearch = document.getElementById('memory-search');
        const wordsList = document.getElementById('words-list');
        const phrasesList = document.getElementById('phrases-list');
        const wordsCount = document.getElementById('words-count');
        const phrasesCount = document.getElementById('phrases-count');
        const exportMemoryBtn = document.getElementById('export-memory');
        const clearAllMemoryBtn = document.getElementById('clear-all-memory');

        // LAAD ALLE DATA VAN GITHUB
        async function loadAllData() {
            try {
                // Laad reacties.txt
                const reactiesResponse = await fetch('https://raw.githubusercontent.com/jimisdebest/ai/main/reacties.txt');
                const reactiesText = await reactiesResponse.text();
                
                // Laad plaatjes.txt
                const plaatjesResponse = await fetch('https://raw.githubusercontent.com/Jimisdebest/combot/main/plaatjes.txt');
                const plaatjesText = await plaatjesResponse.text();
                
                // Parse reacties
                githubQA = [];
                const reactiesLines = reactiesText.split('\n');
                for (const line of reactiesLines) {
                    if (line.includes('=')) {
                        const [question, answer] = line.split('=').map(part => part.trim());
                        if (question && answer) {
                            githubQA.push({
                                question: question.toLowerCase(),
                                answer: answer,
                                containsHTML: answer.includes('<img') || answer.includes('<br') || answer.includes('<a href')
                            });
                        }
                    }
                }
                
                // Parse plaatjes
                imagesQA = [];
                const plaatjesLines = plaatjesText.split('\n');
                for (const line of plaatjesLines) {
                    if (line.includes('=')) {
                        const [question, imageUrl] = line.split('=').map(part => part.trim());
                        if (question && imageUrl) {
                            imagesQA.push({
                                question: question.toLowerCase(),
                                imageUrl: imageUrl,
                                answer: `<img src="${imageUrl}" alt="${question}" style="max-width: 100%; border-radius: 10px;">`,
                                containsHTML: true
                            });
                        }
                    }
                }
                
                console.log(`Geladen: ${githubQA.length} reacties, ${imagesQA.length} afbeeldingen`);
                
            } catch (error) {
                console.error('Fout bij laden van GitHub data:', error);
                // Fallback test data
                githubQA = [
                    { question: "hallo", answer: "Hallo! Hoe gaat het?", containsHTML: false },
                    { question: "hoe gaat het", answer: "Goed, dank je! En met jou?", containsHTML: false }
                ];
                imagesQA = [
                    { question: "maak een aap", imageUrl: "https://images.unsplash.com/photo-1557318041-1ce374d55ebf?w=400&fit=crop", answer: `<img src="https://images.unsplash.com/photo-1557318041-1ce374d55ebf?w=400&fit=crop" alt="Aap" style="max-width: 100%; border-radius: 10px;">`, containsHTML: true },
                    { question: "toon een hond", imageUrl: "https://images.unsplash.com/photo-1552053831-71594a27632d?w=400&fit=crop", answer: `<img src="https://images.unsplash.com/photo-1552053831-71594a27632d?w=400&fit=crop" alt="Hond" style="max-width: 100%; border-radius: 10px;">`, containsHTML: true }
                ];
            }
        }

        // INITIALISEER BOT
        async function initializeBot() {
            // Laad GitHub data
            await loadAllData();
            
            // Laad opgeslagen data
            const storedKnowledgeBase = localStorage.getItem('combotKnowledgeBase');
            const storedLearnedPatterns = localStorage.getItem('combotLearnedPatterns');
            const storedBotPersonality = localStorage.getItem('combotPersonality');
            const storedLearnedQA = localStorage.getItem('combotLearnedQA');
            const storedAnalysisMode = localStorage.getItem('combotAnalysisMode');
            
            // Standaard kennisbasis
            const defaultKnowledgeBase = {
                begroeting: ["Hallo! Leuk je te ontmoeten!", "Hoi! Hoe gaat het?", "Goedendag! Klaar voor een leuk gesprek?"],
                boos: ["Waarom ben je zo boos?", "Laten we rustig praten.", "Ik begrijp dat je boos bent, maar schelden helpt niet."],
                compliment: ["Wat aardig van je! Dankjewel!", "Dank je wel, dat waardeer ik!", "Wat een leuk compliment!"],
                tip: ["Weet je wat leuk is? Lachen is gezond!", "Een goede tip: geniet van de kleine dingen!", "Probeer eens iets nieuws vandaag!"],
                grap: ["Waarom gaan programmeurs altijd met de verkeerde voet uit bed? Omdat ze {alert} gebruiken in plaats van {console.log}!", "Hoe noem je een koe zonder poten? Grondrund!"],
                vraag: ["Dat is een interessante vraag!", "Daar zou ik even over moeten nadenken...", "Goede vraag! Wat denk jij zelf?"],
                afbeelding: ["Hier is een afbeelding voor je!", "Kijk eens wat ik voor je heb gevonden!"]
            };

            const defaultLearnedPatterns = {
                begroeting: ["hallo", "hoi", "hey", "goedendag", "dag", "goedemorgen"],
                boos: ["dommerd", "stommerd", "idioot", "sukkel"],
                compliment: ["mooi", "leuk", "geweldig", "fantastisch", "super"],
                tip: ["tip", "advies", "suggestie", "idee"],
                grap: ["grap", "grappig", "lachen", "mop"],
                vraag: ["waarom", "hoe", "wat", "wanneer", "wie"],
                afbeelding: ["afbeelding", "foto", "plaatje", "beeld", "image", "img"]
            };

            const defaultBotPersonality = {
                name: "Combot",
                mood: "blij",
                favoriteWords: ["leuk", "interessant", "geweldig", "grappig"],
                learnedPhrases: [],
                learnedWords: []
            };
            
            // Gebruik opgeslagen of standaard data
            knowledgeBase = storedKnowledgeBase ? JSON.parse(storedKnowledgeBase) : defaultKnowledgeBase;
            learnedPatterns = storedLearnedPatterns ? JSON.parse(storedLearnedPatterns) : defaultLearnedPatterns;
            botPersonality = storedBotPersonality ? JSON.parse(storedBotPersonality) : defaultBotPersonality;
            learnedQA = storedLearnedQA ? JSON.parse(storedLearnedQA) : [];
            analysisMode = storedAnalysisMode ? JSON.parse(storedAnalysisMode) : false;
            
            // Toon welkomstbericht
            addBotMessage(`Hallo! Ik ben Combot. Typ iets zoals 'maak een aap' of stel een vraag!`, false);
        }

        // CONTROLEER OF ER EEN AFBEELDING GEVRAAGD WORDT
        function isImageRequest(message) {
            const lowerMessage = message.toLowerCase();
            const imageKeywords = ['afbeelding', 'foto', 'plaatje', 'beeld', 'image', 'img', 'maak een', 'toon een', 'laat een zien', 'geef me een'];
            
            for (const keyword of imageKeywords) {
                if (lowerMessage.includes(keyword)) {
                    return true;
                }
            }
            return false;
        }

        // ZOEK BESTE MATCH IN PLAATJES.TXT
        function findBestImage(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = null;
            let bestScore = 0;
            
            // Zoek in imagesQA
            for (const image of imagesQA) {
                const score = calculateSimilarity(lowerMessage, image.question);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = image;
                }
            }
            
            // Alleen teruggeven als er een goede match is (minimaal 40% gelijkenis)
            if (bestMatch && bestScore >= 0.4) {
                return bestMatch;
            }
            
            return null;
        }

        // BEREKEN GELIJKENIS
        function calculateSimilarity(str1, str2) {
            const words1 = str1.toLowerCase().split(' ').filter(w => w.length > 2);
            const words2 = str2.toLowerCase().split(' ').filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return 0;
            
            let matches = 0;
            for (const word1 of words1) {
                if (words2.includes(word1)) {
                    matches++;
                }
            }
            
            return matches / Math.max(words1.length, words2.length);
        }

        // ZOEK BESTE ANTWOORD
        function findBestResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // 1. Eerst exacte match in geleerde QA
            for (const qa of learnedQA) {
                if (lowerMessage === qa.question) {
                    return {
                        answer: qa.answer,
                        containsHTML: qa.containsHTML,
                        source: 'geleerd'
                    };
                }
            }
            
            // 2. Exacte match in GitHub reacties
            for (const qa of githubQA) {
                if (lowerMessage === qa.question) {
                    return {
                        answer: qa.answer,
                        containsHTML: qa.containsHTML,
                        source: 'github'
                    };
                }
            }
            
            // 3. Als het een afbeelding verzoek is, zoek in plaatjes.txt
            if (isImageRequest(message)) {
                const bestImage = findBestImage(message);
                if (bestImage) {
                    return {
                        answer: bestImage.answer,
                        containsHTML: true,
                        source: 'plaatjes'
                    };
                }
            }
            
            // 4. Zoek naar beste match in GitHub reacties (minimaal 70%)
            let bestGithubMatch = null;
            let bestGithubScore = 0;
            
            for (const qa of githubQA) {
                const score = calculateSimilarity(lowerMessage, qa.question);
                if (score > bestGithubScore) {
                    bestGithubScore = score;
                    bestGithubMatch = qa;
                }
            }
            
            if (bestGithubMatch && bestGithubScore >= 0.7) {
                return {
                    answer: bestGithubMatch.answer,
                    containsHTML: bestGithubMatch.containsHTML,
                    source: 'github'
                };
            }
            
            // 5. Fallback naar standaard kennis (SmartBot)
            const category = categorizeMessage(message);
            if (knowledgeBase[category] && knowledgeBase[category].length > 0) {
                const response = knowledgeBase[category][Math.floor(Math.random() * knowledgeBase[category].length)];
                return {
                    answer: response,
                    containsHTML: false,
                    source: 'standaard'
                };
            }
            
            // 6. Laatste fallback
            return {
                answer: "Dat begrijp ik niet. Kun je het anders formuleren?",
                containsHTML: false,
                source: 'fallback'
            };
        }

        // CATEGORISEER BERICHT
        function categorizeMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const category in learnedPatterns) {
                for (const word of learnedPatterns[category]) {
                    if (lowerMessage.includes(word)) {
                        return category;
                    }
                }
            }
            
            return "vraag";
        }

        // VOEG BERICHTEN TOE
        function addUserMessage(message) {
            const div = document.createElement('div');
            div.className = 'message user-message';
            div.textContent = message;
            chatContainer.appendChild(div);
            scrollToBottom();
            
            // Leer van bericht
            learnFromMessage(message);
            totalMessages++;
            saveData();
        }

        function addBotMessage(message, containsHTML) {
            const div = document.createElement('div');
            div.className = 'message bot-message';
            
            if (containsHTML) {
                div.innerHTML = message;
            } else {
                div.textContent = message;
            }
            
            chatContainer.appendChild(div);
            scrollToBottom();
            totalMessages++;
            saveData();
            
            // Voeg analyse bericht toe als analyse modus aan staat
            if (analysisMode) {
                setTimeout(() => {
                    const analysisDiv = document.createElement('div');
                    analysisDiv.className = 'analysis-message';
                    analysisDiv.textContent = "✓ Antwoord gegenereerd via het gevonden pad.";
                    chatContainer.appendChild(analysisDiv);
                    scrollToBottom();
                }, 100);
            }
        }

        // LEER VAN BERICHT
        function learnFromMessage(message) {
            const words = message.toLowerCase().split(/\s+/);
            
            if (words.length <= 3) {
                // Korte berichten = woorden
                for (const word of words) {
                    const cleanWord = word.replace(/[^\w]/g, '');
                    if (cleanWord.length < 3) continue;
                    
                    let exists = false;
                    for (const cat in learnedPatterns) {
                        if (learnedPatterns[cat].includes(cleanWord)) {
                            exists = true;
                            break;
                        }
                    }
                    
                    if (!exists) {
                        const category = categorizeMessage(cleanWord);
                        if (!learnedPatterns[category]) learnedPatterns[category] = [];
                        learnedPatterns[category].push(cleanWord);
                        botPersonality.learnedWords.push(cleanWord);
                        totalLearned++;
                    }
                }
            } else {
                // Lange berichten = zinnen
                let exists = false;
                for (const cat in knowledgeBase) {
                    if (knowledgeBase[cat].includes(message)) {
                        exists = true;
                        break;
                    }
                }
                
                if (!exists) {
                    const category = categorizeMessage(message);
                    if (!knowledgeBase[category]) knowledgeBase[category] = [];
                    knowledgeBase[category].push(message);
                    botPersonality.learnedPhrases.push(message);
                    totalLearned++;
                }
            }
        }

        // LEER NIEUWE QA
        function learnNewQA(input) {
            if (input.toLowerCase().startsWith('leer ')) {
                const content = input.substring(5).trim();
                if (content.includes('=')) {
                    const [question, answer] = content.split('=').map(part => part.trim());
                    if (question && answer) {
                        const containsHTML = answer.includes('<img') || answer.includes('<br') || answer.includes('<a href');
                        
                        learnedQA.push({
                            question: question.toLowerCase(),
                            answer: answer,
                            containsHTML: containsHTML
                        });
                        
                        totalLearned++;
                        saveData();
                        updateMemoryManagement();
                        return `Bedankt! Ik heb geleerd: "${question}" = "${answer}"`;
                    }
                }
                return "Gebruik: leer [vraag] = [antwoord]";
            }
            return null;
        }

        // SAVE DATA
        function saveData() {
            localStorage.setItem('combotKnowledgeBase', JSON.stringify(knowledgeBase));
            localStorage.setItem('combotLearnedPatterns', JSON.stringify(learnedPatterns));
            localStorage.setItem('combotPersonality', JSON.stringify(botPersonality));
            localStorage.setItem('combotLearnedQA', JSON.stringify(learnedQA));
            localStorage.setItem('combotAnalysisMode', JSON.stringify(analysisMode));
        }

        // UPDATE GEHEUGEN BEHEER
        function updateMemoryManagement() {
            const searchTerm = memorySearch.value.toLowerCase();
            
            // Update woordenlijst
            wordsList.innerHTML = "";
            let wordCount = 0;
            const allWords = [];
            
            for (const category in learnedPatterns) {
                learnedPatterns[category].forEach(word => {
                    if (!allWords.includes(word)) allWords.push(word);
                });
            }
            
            botPersonality.learnedWords.forEach(word => {
                if (!allWords.includes(word)) allWords.push(word);
            });
            
            allWords.forEach(word => {
                if (searchTerm === '' || word.toLowerCase().includes(searchTerm)) {
                    const wordItem = document.createElement('div');
                    wordItem.className = 'word-item';
                    wordItem.innerHTML = `${word}<button class="delete-word" onclick="deleteWord('${word.replace(/'/g, "\\'")}')">×</button>`;
                    wordsList.appendChild(wordItem);
                    wordCount++;
                }
            });
            wordsCount.textContent = wordCount;
            
            // Update zinnenlijst
            phrasesList.innerHTML = "";
            let phraseCount = 0;
            
            for (const category in knowledgeBase) {
                knowledgeBase[category].forEach(phrase => {
                    if (searchTerm === '' || phrase.toLowerCase().includes(searchTerm)) {
                        const phraseItem = document.createElement('div');
                        phraseItem.className = 'phrase-item';
                        phraseItem.innerHTML = `${phrase}<button class="delete-phrase" onclick="deletePhrase('${category.replace(/'/g, "\\'")}', '${phrase.replace(/'/g, "\\'")}')">×</button>`;
                        phrasesList.appendChild(phraseItem);
                        phraseCount++;
                    }
                });
            }
            phrasesCount.textContent = phraseCount;
        }

        // DELETE FUNCTIES
        function deleteWord(word) {
            for (const category in learnedPatterns) {
                const index = learnedPatterns[category].indexOf(word);
                if (index !== -1) learnedPatterns[category].splice(index, 1);
            }
            
            const wordIndex = botPersonality.learnedWords.indexOf(word);
            if (wordIndex !== -1) botPersonality.learnedWords.splice(wordIndex, 1);
            
            saveData();
            updateMemoryManagement();
            addBotMessage(`Woord "${word}" verwijderd uit geheugen.`, false);
        }

        function deletePhrase(category, phrase) {
            const index = knowledgeBase[category].indexOf(phrase);
            if (index !== -1) {
                knowledgeBase[category].splice(index, 1);
                const phraseIndex = botPersonality.learnedPhrases.indexOf(phrase);
                if (phraseIndex !== -1) botPersonality.learnedPhrases.splice(phraseIndex, 1);
                saveData();
                updateMemoryManagement();
                addBotMessage(`Zin verwijderd uit categorie "${category}".`, false);
            }
        }

        // SCROLL
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        // VERWERK INPUT
        function handleUserInput() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Leer commando
            if (message.toLowerCase().startsWith('leer ')) {
                const result = learnNewQA(message);
                addUserMessage(message);
                addBotMessage(result || "Gebruik: leer [vraag] = [antwoord]", false);
                userInput.value = '';
                return;
            }
            
            // Normaal bericht
            addUserMessage(message);
            
            // Denkproces tonen
            const thinking = document.createElement('div');
            thinking.className = 'thinking';
            thinking.innerHTML = 'Combot denkt na<span class="thinking-dots"><span></span><span></span><span></span></span>';
            chatContainer.appendChild(thinking);
            scrollToBottom();
            
            // Antwoord na korte vertraging
            setTimeout(() => {
                thinking.remove();
                const response = findBestResponse(message);
                addBotMessage(response.answer, response.containsHTML);
                userInput.value = '';
                userInput.focus();
            }, 1000);
        }

        // EVENT LISTENERS
        window.onload = function() {
            initializeBot();
            
            // Sidebar functionaliteit
            hamburgerMenu.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                if (memoryManagement.classList.contains('active')) {
                    memoryManagement.classList.remove('active');
                }
            });
            
            // Send knop
            sendBtn.addEventListener('click', handleUserInput);
            
            // Enter toets
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleUserInput();
            });
            
            // Analyse knop
            analysisBtn.addEventListener('click', () => {
                analysisMode = !analysisMode;
                analysisBtn.textContent = analysisMode ? "Analyse Uit" : "Analyse Aan";
                analysisBtn.classList.toggle('active', analysisMode);
                saveData();
                addBotMessage(`Analyse modus is nu ${analysisMode ? 'ingeschakeld' : 'uitgeschakeld'}.`, false);
            });
            
            // Spraakmodus knop
            speechModeBtn.addEventListener('click', () => {
                window.location.href = 'spraak.html';
            });
            
            // Geheugen beheer knop
            memoryManagementBtn.addEventListener('click', () => {
                memoryManagement.classList.add('active');
                overlay.classList.add('active');
                updateMemoryManagement();
            });
            
            // Sluit geheugen beheer
            closeMemory.addEventListener('click', () => {
                memoryManagement.classList.remove('active');
                overlay.classList.remove('active');
            });
            
            // Zoek in geheugen
            memorySearch.addEventListener('input', updateMemoryManagement);
            
            // Export geheugen
            exportMemoryBtn.addEventListener('click', () => {
                const memoryData = {
                    learnedPatterns: learnedPatterns,
                    knowledgeBase: knowledgeBase,
                    botPersonality: botPersonality,
                    learnedQA: learnedQA
                };
                
                const dataStr = JSON.stringify(memoryData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'combot-geheugen.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                addBotMessage("Geheugen geëxporteerd!", false);
            });
            
            // Wis alle geheugen
            clearAllMemoryBtn.addEventListener('click', () => {
                if (confirm("Weet je zeker dat je ALLES uit het geheugen wilt verwijderen?")) {
                    localStorage.clear();
                    location.reload();
                }
            });
        };
    </script>
</body>
</html>
